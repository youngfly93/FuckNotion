<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuckNotion Storage Checker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .storage-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <h1>ğŸ” FuckNotion Storage Checker</h1>
    <p>è¿™ä¸ªå·¥å…·å¸®åŠ©ä½ æ£€æŸ¥ FuckNotion çš„å­˜å‚¨çŠ¶æ€å’Œæ•°æ®è¿ç§»æƒ…å†µã€‚</p>

    <div id="results"></div>

    <div>
        <button onclick="checkStorage()">ğŸ” æ£€æŸ¥å­˜å‚¨çŠ¶æ€</button>
        <button onclick="checkIndexedDB()">ğŸ’¾ æ£€æŸ¥ IndexedDB</button>
        <button onclick="checkLocalStorage()">ğŸ“¦ æ£€æŸ¥ localStorage</button>
        <button onclick="checkMigration()">ğŸ”„ æ£€æŸ¥è¿ç§»çŠ¶æ€</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
    </div>

    <script>
        const results = document.getElementById('results');

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        async function checkStorage() {
            clearResults();
            addResult('info', 'ğŸ” å¼€å§‹æ£€æŸ¥å­˜å‚¨çŠ¶æ€...', 'æ­£åœ¨åˆ†æå½“å‰çš„å­˜å‚¨é…ç½®');

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            const support = {
                indexedDB: 'indexedDB' in window,
                localStorage: 'localStorage' in window,
                storageEstimate: 'storage' in navigator && 'estimate' in navigator.storage,
                persistentStorage: 'storage' in navigator && 'persist' in navigator.storage
            };

            addResult('info', 'ğŸŒ æµè§ˆå™¨æ”¯æŒæƒ…å†µ', `
                <ul>
                    <li>IndexedDB: ${support.indexedDB ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</li>
                    <li>localStorage: ${support.localStorage ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</li>
                    <li>Storage Estimate API: ${support.storageEstimate ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</li>
                    <li>Persistent Storage: ${support.persistentStorage ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ'}</li>
                </ul>
            `);

            // æ£€æŸ¥å­˜å‚¨é…é¢
            if (support.storageEstimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                    const quotaMB = (estimate.quota / 1024 / 1024).toFixed(2);
                    const percentUsed = ((estimate.usage / estimate.quota) * 100).toFixed(2);

                    addResult('success', 'ğŸ’¾ å­˜å‚¨é…é¢ä¿¡æ¯', `
                        <ul>
                            <li>å·²ä½¿ç”¨: ${usedMB} MB</li>
                            <li>æ€»é…é¢: ${quotaMB} MB</li>
                            <li>ä½¿ç”¨ç‡: ${percentUsed}%</li>
                        </ul>
                    `);
                } catch (error) {
                    addResult('error', 'âŒ è·å–å­˜å‚¨é…é¢å¤±è´¥', error.message);
                }
            }

            // æ£€æŸ¥æŒä¹…å­˜å‚¨
            if (support.persistentStorage) {
                try {
                    const isPersistent = await navigator.storage.persisted();
                    addResult(isPersistent ? 'success' : 'warning', 
                        'ğŸ”’ æŒä¹…å­˜å‚¨çŠ¶æ€', 
                        isPersistent ? 'âœ… å·²å¯ç”¨æŒä¹…å­˜å‚¨' : 'âš ï¸ æœªå¯ç”¨æŒä¹…å­˜å‚¨ï¼ˆæ•°æ®å¯èƒ½è¢«æ¸…ç†ï¼‰'
                    );
                } catch (error) {
                    addResult('error', 'âŒ æ£€æŸ¥æŒä¹…å­˜å‚¨å¤±è´¥', error.message);
                }
            }
        }

        async function checkIndexedDB() {
            if (!('indexedDB' in window)) {
                addResult('error', 'âŒ IndexedDB ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB');
                return;
            }

            try {
                // å°è¯•æ‰“å¼€ FuckNotionDB
                const request = indexedDB.open('FuckNotionDB');
                
                request.onsuccess = async function(event) {
                    const db = event.target.result;
                    
                    addResult('success', 'âœ… IndexedDB è¿æ¥æˆåŠŸ', `
                        <ul>
                            <li>æ•°æ®åº“åç§°: ${db.name}</li>
                            <li>ç‰ˆæœ¬: ${db.version}</li>
                            <li>å¯¹è±¡å­˜å‚¨: ${Array.from(db.objectStoreNames).join(', ')}</li>
                        </ul>
                    `);

                    // æ£€æŸ¥å„ä¸ªè¡¨çš„æ•°æ®
                    const transaction = db.transaction(['pages', 'settings'], 'readonly');
                    
                    // æ£€æŸ¥é¡µé¢æ•°æ®
                    const pagesStore = transaction.objectStore('pages');
                    const pagesRequest = pagesStore.count();
                    
                    pagesRequest.onsuccess = function() {
                        addResult('info', 'ğŸ“„ é¡µé¢æ•°æ®', `å…±æœ‰ ${pagesRequest.result} ä¸ªé¡µé¢å­˜å‚¨åœ¨ IndexedDB ä¸­`);
                    };

                    // æ£€æŸ¥è®¾ç½®æ•°æ®
                    const settingsStore = transaction.objectStore('settings');
                    const settingsRequest = settingsStore.getAll();
                    
                    settingsRequest.onsuccess = function() {
                        const settings = settingsRequest.result;
                        addResult('info', 'âš™ï¸ è®¾ç½®æ•°æ®', `
                            <div>å…±æœ‰ ${settings.length} ä¸ªè®¾ç½®é¡¹ï¼š</div>
                            <ul>
                                ${settings.map(s => `<li><strong>${s.key}</strong>: ${JSON.stringify(s.value)}</li>`).join('')}
                            </ul>
                        `);
                    };

                    db.close();
                };

                request.onerror = function(event) {
                    addResult('error', 'âŒ IndexedDB è¿æ¥å¤±è´¥', event.target.error);
                };

                request.onupgradeneeded = function(event) {
                    addResult('warning', 'âš ï¸ IndexedDB éœ€è¦å‡çº§', 'æ•°æ®åº“ç»“æ„éœ€è¦æ›´æ–°');
                };

            } catch (error) {
                addResult('error', 'âŒ IndexedDB æ£€æŸ¥å¤±è´¥', error.message);
            }
        }

        function checkLocalStorage() {
            if (!('localStorage' in window)) {
                addResult('error', 'âŒ localStorage ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ localStorage');
                return;
            }

            try {
                const items = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('novel') || key.includes('notion') || key.includes('fuck'))) {
                        const value = localStorage.getItem(key);
                        const size = new Blob([value]).size;
                        items.push({
                            key,
                            size: (size / 1024).toFixed(2) + ' KB',
                            preview: value.length > 100 ? value.substring(0, 100) + '...' : value
                        });
                    }
                }

                if (items.length > 0) {
                    addResult('info', 'ğŸ“¦ localStorage ç›¸å…³æ•°æ®', `
                        <div>æ‰¾åˆ° ${items.length} ä¸ªç›¸å…³é¡¹ç›®ï¼š</div>
                        ${items.map(item => `
                            <div class="storage-item">
                                <strong>${item.key}</strong> (${item.size})<br>
                                <small>${item.preview}</small>
                            </div>
                        `).join('')}
                    `);
                } else {
                    addResult('success', 'âœ… localStorage æ¸…ç†å®Œæˆ', 'æ²¡æœ‰æ‰¾åˆ°æ—§çš„ localStorage æ•°æ®ï¼Œè¯´æ˜è¿ç§»å·²å®Œæˆ');
                }

            } catch (error) {
                addResult('error', 'âŒ localStorage æ£€æŸ¥å¤±è´¥', error.message);
            }
        }

        async function checkMigration() {
            addResult('info', 'ğŸ”„ æ£€æŸ¥è¿ç§»çŠ¶æ€...', 'æ­£åœ¨åˆ†ææ•°æ®è¿ç§»æƒ…å†µ');

            // æ£€æŸ¥æ˜¯å¦æœ‰æ—§æ•°æ®
            const hasOldData = localStorage.getItem('novel-pages') || 
                              localStorage.getItem('novel-settings') ||
                              localStorage.getItem('pages');

            if (hasOldData) {
                addResult('warning', 'âš ï¸ å‘ç°æ—§æ•°æ®', 'åœ¨ localStorage ä¸­å‘ç°æ—§æ•°æ®ï¼Œå¯èƒ½éœ€è¦è¿ç§»');
            } else {
                addResult('success', 'âœ… æ— æ—§æ•°æ®', 'localStorage ä¸­æ²¡æœ‰å‘ç°éœ€è¦è¿ç§»çš„æ—§æ•°æ®');
            }

            // æ£€æŸ¥ IndexedDB ä¸­æ˜¯å¦æœ‰æ•°æ®
            await checkIndexedDB();
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            addResult('info', 'ğŸš€ FuckNotion Storage Checker', 'é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥å­˜å‚¨çŠ¶æ€');
        });
    </script>
</body>
</html>
