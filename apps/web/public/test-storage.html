<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuckNotion Storage Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .data-display {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª FuckNotion Storage Test</h1>
    <p>è¿™ä¸ªé¡µé¢ä¼šå®æ—¶æµ‹è¯• FuckNotion çš„å­˜å‚¨ç³»ç»Ÿï¼ŒéªŒè¯æ˜¯å¦æ­£åœ¨ä½¿ç”¨ IndexedDBã€‚</p>

    <div class="test-section">
        <h2>ğŸ“Š å®æ—¶å­˜å‚¨æµ‹è¯•</h2>
        <button onclick="testWrite()">âœï¸ å†™å…¥æµ‹è¯•æ•°æ®</button>
        <button onclick="testRead()">ğŸ“– è¯»å–æ•°æ®</button>
        <button onclick="testIndexedDB()">ğŸ’¾ æ£€æŸ¥ IndexedDB</button>
        <button onclick="testLocalStorage()">ğŸ“¦ æ£€æŸ¥ localStorage</button>
        <button onclick="clearAll()">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
    </div>

    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            results.innerHTML = '';
        }

        // æµ‹è¯•å†™å…¥æ•°æ®
        async function testWrite() {
            clearResults();
            addResult('', 'âœï¸ å¼€å§‹å†™å…¥æµ‹è¯•', 'æ­£åœ¨å†™å…¥æµ‹è¯•æ•°æ®åˆ°å­˜å‚¨ç³»ç»Ÿ...');

            try {
                // æ¨¡æ‹Ÿé¡µé¢æ•°æ®
                const testPageData = {
                    title: `æµ‹è¯•é¡µé¢ ${new Date().toLocaleTimeString()}`,
                    content: {
                        type: 'doc',
                        content: [
                            {
                                type: 'paragraph',
                                content: [
                                    { type: 'text', text: `è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡µé¢ï¼Œåˆ›å»ºæ—¶é—´ï¼š${new Date().toLocaleString()}` }
                                ]
                            }
                        ]
                    }
                };

                // å°è¯•å†™å…¥ IndexedDB
                const request = indexedDB.open('FuckNotionDB', 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(['pages'], 'readwrite');
                    const store = transaction.objectStore('pages');
                    
                    const pageData = {
                        slug: 'test-page-' + Date.now(),
                        title: testPageData.title,
                        content: testPageData.content,
                        textContent: testPageData.title,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    };
                    
                    const addRequest = store.add(pageData);
                    
                    addRequest.onsuccess = function() {
                        addResult('success', 'âœ… IndexedDB å†™å…¥æˆåŠŸ', `
                            <p>æˆåŠŸå†™å…¥æ•°æ®åˆ° IndexedDBï¼</p>
                            <pre>${JSON.stringify(pageData, null, 2)}</pre>
                        `);
                    };
                    
                    addRequest.onerror = function(e) {
                        addResult('error', 'âŒ IndexedDB å†™å…¥å¤±è´¥', `é”™è¯¯ï¼š${e.target.error}`);
                    };
                };
                
                request.onerror = function(e) {
                    addResult('error', 'âŒ æ— æ³•æ‰“å¼€ IndexedDB', `é”™è¯¯ï¼š${e.target.error}`);
                };

            } catch (error) {
                addResult('error', 'âŒ å†™å…¥æµ‹è¯•å¤±è´¥', `é”™è¯¯ï¼š${error.message}`);
            }
        }

        // æµ‹è¯•è¯»å–æ•°æ®
        async function testRead() {
            clearResults();
            addResult('', 'ğŸ“– å¼€å§‹è¯»å–æµ‹è¯•', 'æ­£åœ¨ä»å­˜å‚¨ç³»ç»Ÿè¯»å–æ•°æ®...');

            try {
                const request = indexedDB.open('FuckNotionDB', 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(['pages'], 'readonly');
                    const store = transaction.objectStore('pages');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = function() {
                        const pages = getAllRequest.result;
                        
                        if (pages.length > 0) {
                            addResult('success', `âœ… IndexedDB è¯»å–æˆåŠŸ`, `
                                <p>æ‰¾åˆ° ${pages.length} ä¸ªé¡µé¢ï¼š</p>
                                <div class="data-display">
                                    ${pages.map(page => `
                                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                            <strong>${page.title}</strong><br>
                                            <small>Slug: ${page.slug}</small><br>
                                            <small>åˆ›å»ºæ—¶é—´: ${new Date(page.createdAt).toLocaleString()}</small><br>
                                            <small>æ›´æ–°æ—¶é—´: ${new Date(page.updatedAt).toLocaleString()}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            `);
                        } else {
                            addResult('warning', 'âš ï¸ IndexedDB ä¸ºç©º', 'IndexedDB ä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é¡µé¢æ•°æ®');
                        }
                    };
                    
                    getAllRequest.onerror = function(e) {
                        addResult('error', 'âŒ è¯»å–å¤±è´¥', `é”™è¯¯ï¼š${e.target.error}`);
                    };
                };
                
                request.onerror = function(e) {
                    addResult('error', 'âŒ æ— æ³•æ‰“å¼€ IndexedDB', `é”™è¯¯ï¼š${e.target.error}`);
                };

            } catch (error) {
                addResult('error', 'âŒ è¯»å–æµ‹è¯•å¤±è´¥', `é”™è¯¯ï¼š${error.message}`);
            }
        }

        // æ£€æŸ¥ IndexedDB çŠ¶æ€
        async function testIndexedDB() {
            clearResults();
            addResult('', 'ğŸ’¾ æ£€æŸ¥ IndexedDB', 'æ­£åœ¨æ£€æŸ¥ IndexedDB æ•°æ®åº“çŠ¶æ€...');

            if (!('indexedDB' in window)) {
                addResult('error', 'âŒ IndexedDB ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB');
                return;
            }

            try {
                // æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
                const request = indexedDB.open('FuckNotionDB');
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    
                    addResult('success', 'âœ… IndexedDB æ•°æ®åº“å­˜åœ¨', `
                        <ul>
                            <li>æ•°æ®åº“åç§°: ${db.name}</li>
                            <li>ç‰ˆæœ¬: ${db.version}</li>
                            <li>å¯¹è±¡å­˜å‚¨: ${Array.from(db.objectStoreNames).join(', ')}</li>
                        </ul>
                    `);

                    // æ£€æŸ¥å„è¡¨çš„æ•°æ®é‡
                    const transaction = db.transaction(db.objectStoreNames, 'readonly');
                    
                    Array.from(db.objectStoreNames).forEach(storeName => {
                        const store = transaction.objectStore(storeName);
                        const countRequest = store.count();
                        
                        countRequest.onsuccess = function() {
                            addResult('', `ğŸ“Š ${storeName} è¡¨`, `åŒ…å« ${countRequest.result} æ¡è®°å½•`);
                        };
                    });

                    db.close();
                };
                
                request.onerror = function(e) {
                    addResult('error', 'âŒ IndexedDB è¿æ¥å¤±è´¥', `é”™è¯¯ï¼š${e.target.error}`);
                };

            } catch (error) {
                addResult('error', 'âŒ IndexedDB æ£€æŸ¥å¤±è´¥', `é”™è¯¯ï¼š${error.message}`);
            }
        }

        // æ£€æŸ¥ localStorage
        function testLocalStorage() {
            clearResults();
            addResult('', 'ğŸ“¦ æ£€æŸ¥ localStorage', 'æ­£åœ¨æ£€æŸ¥ localStorage ä¸­çš„æ•°æ®...');

            try {
                const relevantKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('novel') || key.includes('notion') || key.includes('fuck'))) {
                        relevantKeys.push(key);
                    }
                }

                if (relevantKeys.length > 0) {
                    addResult('warning', 'âš ï¸ å‘ç° localStorage æ•°æ®', `
                        <p>åœ¨ localStorage ä¸­å‘ç° ${relevantKeys.length} ä¸ªç›¸å…³é¡¹ç›®ï¼š</p>
                        <ul>
                            ${relevantKeys.map(key => {
                                const value = localStorage.getItem(key);
                                const size = new Blob([value]).size;
                                return `<li><strong>${key}</strong> (${(size/1024).toFixed(2)} KB)</li>`;
                            }).join('')}
                        </ul>
                        <p><small>è¿™å¯èƒ½è¡¨ç¤ºæ•°æ®è¿˜åœ¨ä½¿ç”¨ localStorage æˆ–è€…è¿ç§»æœªå®Œæˆ</small></p>
                    `);
                } else {
                    addResult('success', 'âœ… localStorage å·²æ¸…ç†', 'æ²¡æœ‰å‘ç°ç›¸å…³çš„ localStorage æ•°æ®ï¼Œè¯´æ˜å·²æˆåŠŸè¿ç§»åˆ° IndexedDB');
                }

            } catch (error) {
                addResult('error', 'âŒ localStorage æ£€æŸ¥å¤±è´¥', `é”™è¯¯ï¼š${error.message}`);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        async function clearAll() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜å‚¨æ•°æ®å—ï¼Ÿè¿™ä¸ªæ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }

            clearResults();
            addResult('warning', 'ğŸ§¹ æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'æ­£åœ¨æ¸…ç©º IndexedDB å’Œ localStorage...');

            try {
                // æ¸…ç©º IndexedDB
                const deleteRequest = indexedDB.deleteDatabase('FuckNotionDB');
                
                deleteRequest.onsuccess = function() {
                    addResult('success', 'âœ… IndexedDB å·²æ¸…ç©º', 'FuckNotionDB æ•°æ®åº“å·²åˆ é™¤');
                };
                
                deleteRequest.onerror = function(e) {
                    addResult('error', 'âŒ IndexedDB æ¸…ç©ºå¤±è´¥', `é”™è¯¯ï¼š${e.target.error}`);
                };

                // æ¸…ç©ºç›¸å…³çš„ localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('novel') || key.includes('notion') || key.includes('fuck'))) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                if (keysToRemove.length > 0) {
                    addResult('success', 'âœ… localStorage å·²æ¸…ç©º', `åˆ é™¤äº† ${keysToRemove.length} ä¸ªé¡¹ç›®`);
                }

            } catch (error) {
                addResult('error', 'âŒ æ¸…ç©ºå¤±è´¥', `é”™è¯¯ï¼š${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            addResult('', 'ğŸš€ å­˜å‚¨æµ‹è¯•å·¥å…·å·²åŠ è½½', 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å­˜å‚¨ç³»ç»Ÿ');
        });
    </script>
</body>
</html>
