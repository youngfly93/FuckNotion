<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FuckNotion ä¾§è¾¹æ è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        pre {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .step.success { border-left-color: #28a745; background: #d4edda; }
        .step.error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>ğŸ› FuckNotion ä¾§è¾¹æ è°ƒè¯•å·¥å…·</h1>
    <p>è¿™ä¸ªå·¥å…·ä¼šå¸®ä½ è¯Šæ–­ä¾§è¾¹æ æ·»åŠ é¡µé¢åŠŸèƒ½çš„é—®é¢˜ã€‚</p>

    <div class="debug-section">
        <h2>ğŸ”§ å¿«é€Ÿæµ‹è¯•</h2>
        <button onclick="testPageCreation()">ğŸ§ª æµ‹è¯•é¡µé¢åˆ›å»ºæµç¨‹</button>
        <button onclick="testIndexedDB()">ğŸ’¾ æµ‹è¯• IndexedDB è¿æ¥</button>
        <button onclick="testNavigation()">ğŸ§­ æµ‹è¯•è·¯ç”±å¯¼èˆª</button>
        <button onclick="simulateAddPage()">â• æ¨¡æ‹Ÿæ·»åŠ é¡µé¢</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function addResult(type, title, content) {
            const div = document.createElement('div');
            div.className = `debug-section ${type}`;
            div.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            results.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function addStep(type, content) {
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = content;
            results.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
        }

        // æµ‹è¯•é¡µé¢åˆ›å»ºæµç¨‹
        async function testPageCreation() {
            clearResults();
            addResult('', 'ğŸ§ª å¼€å§‹æµ‹è¯•é¡µé¢åˆ›å»ºæµç¨‹', 'æ­£åœ¨é€æ­¥æµ‹è¯•é¡µé¢åˆ›å»ºçš„å„ä¸ªç¯èŠ‚...');

            // æ­¥éª¤ 1: ç”Ÿæˆ slug
            addStep('', 'ğŸ“ æ­¥éª¤ 1: ç”Ÿæˆé¡µé¢ slug');
            const timestamp = Date.now();
            const slug = `untitled-${timestamp}`;
            addStep('success', `âœ… ç”Ÿæˆ slug: ${slug}`);

            // æ­¥éª¤ 2: æµ‹è¯• IndexedDB è¿æ¥
            addStep('', 'ğŸ’¾ æ­¥éª¤ 2: æµ‹è¯• IndexedDB è¿æ¥');
            try {
                const request = indexedDB.open('FuckNotionDB', 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    addStep('success', `âœ… IndexedDB è¿æ¥æˆåŠŸ (ç‰ˆæœ¬: ${db.version})`);
                    
                    // æ­¥éª¤ 3: æµ‹è¯•é¡µé¢ä¿å­˜
                    testPageSave(db, slug);
                };
                
                request.onerror = function(e) {
                    addStep('error', `âŒ IndexedDB è¿æ¥å¤±è´¥: ${e.target.error}`);
                };
            } catch (error) {
                addStep('error', `âŒ IndexedDB æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        // æµ‹è¯•é¡µé¢ä¿å­˜
        function testPageSave(db, slug) {
            addStep('', 'ğŸ’¾ æ­¥éª¤ 3: æµ‹è¯•é¡µé¢ä¿å­˜åˆ° IndexedDB');
            
            try {
                const transaction = db.transaction(['pages'], 'readwrite');
                const store = transaction.objectStore('pages');
                
                const pageData = {
                    slug: slug,
                    title: 'Untitled',
                    content: {
                        type: 'doc',
                        content: [
                            {
                                type: 'paragraph',
                                content: [{ type: 'text', text: '' }]
                            }
                        ]
                    },
                    textContent: 'Untitled',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                const addRequest = store.add(pageData);
                
                addRequest.onsuccess = function() {
                    addStep('success', 'âœ… é¡µé¢ä¿å­˜æˆåŠŸ');
                    
                    // æ­¥éª¤ 4: æµ‹è¯•è·¯ç”±å¯¼èˆª
                    testRouteNavigation(slug);
                };
                
                addRequest.onerror = function(e) {
                    addStep('error', `âŒ é¡µé¢ä¿å­˜å¤±è´¥: ${e.target.error}`);
                };
                
                transaction.onerror = function(e) {
                    addStep('error', `âŒ äº‹åŠ¡å¤±è´¥: ${e.target.error}`);
                };
                
            } catch (error) {
                addStep('error', `âŒ é¡µé¢ä¿å­˜å¼‚å¸¸: ${error.message}`);
            }
        }

        // æµ‹è¯•è·¯ç”±å¯¼èˆª
        function testRouteNavigation(slug) {
            addStep('', 'ğŸ§­ æ­¥éª¤ 4: æµ‹è¯•è·¯ç”±å¯¼èˆª');
            
            try {
                const targetUrl = `/page/${slug}?new=true`;
                addStep('success', `âœ… ç›®æ ‡ URL: ${targetUrl}`);
                
                // æ£€æŸ¥å½“å‰æ˜¯å¦åœ¨æ­£ç¡®çš„åŸŸåä¸‹
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('localhost')) {
                    addStep('success', 'âœ… è¿è¡Œç¯å¢ƒæ­£å¸¸');
                    
                    // æä¾›å¯¼èˆªé€‰é¡¹
                    addStep('', `
                        <div style="margin: 10px 0;">
                            <button onclick="window.location.href='${targetUrl}'" style="background: #28a745;">
                                ğŸš€ å¯¼èˆªåˆ°æµ‹è¯•é¡µé¢
                            </button>
                            <button onclick="window.open('${targetUrl}', '_blank')" style="background: #17a2b8;">
                                ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                            </button>
                        </div>
                    `);
                } else {
                    addStep('warning', 'âš ï¸ è¯·ç¡®ä¿åœ¨æ­£ç¡®çš„å¼€å‘ç¯å¢ƒä¸­è¿è¡Œæ­¤æµ‹è¯•');
                }
                
            } catch (error) {
                addStep('error', `âŒ è·¯ç”±æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            }
        }

        // æµ‹è¯• IndexedDB
        async function testIndexedDB() {
            clearResults();
            addResult('', 'ğŸ’¾ IndexedDB è¿æ¥æµ‹è¯•', 'æ­£åœ¨æµ‹è¯• IndexedDB çš„å„é¡¹åŠŸèƒ½...');

            if (!('indexedDB' in window)) {
                addResult('error', 'âŒ IndexedDB ä¸æ”¯æŒ', 'å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ IndexedDB');
                return;
            }

            try {
                const request = indexedDB.open('FuckNotionDB', 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    
                    addResult('success', 'âœ… IndexedDB è¿æ¥æˆåŠŸ', `
                        <ul>
                            <li>æ•°æ®åº“åç§°: ${db.name}</li>
                            <li>ç‰ˆæœ¬: ${db.version}</li>
                            <li>å¯¹è±¡å­˜å‚¨: ${Array.from(db.objectStoreNames).join(', ')}</li>
                        </ul>
                    `);

                    // æµ‹è¯•è¯»å†™æƒé™
                    testReadWritePermissions(db);
                };
                
                request.onerror = function(e) {
                    addResult('error', 'âŒ IndexedDB è¿æ¥å¤±è´¥', `é”™è¯¯: ${e.target.error}`);
                };

                request.onupgradeneeded = function(event) {
                    addResult('warning', 'âš ï¸ æ•°æ®åº“éœ€è¦å‡çº§', 'æ­£åœ¨åˆ›å»ºæˆ–å‡çº§æ•°æ®åº“ç»“æ„...');
                };

            } catch (error) {
                addResult('error', 'âŒ IndexedDB æµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•è¯»å†™æƒé™
        function testReadWritePermissions(db) {
            try {
                const transaction = db.transaction(['pages'], 'readwrite');
                const store = transaction.objectStore('pages');
                
                // æµ‹è¯•å†™å…¥
                const testData = {
                    slug: 'test-permissions-' + Date.now(),
                    title: 'Permission Test',
                    content: { type: 'doc', content: [] },
                    textContent: 'Permission Test',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                const addRequest = store.add(testData);
                
                addRequest.onsuccess = function() {
                    addResult('success', 'âœ… è¯»å†™æƒé™æ­£å¸¸', 'å¯ä»¥æ­£å¸¸å†™å…¥å’Œè¯»å–æ•°æ®');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    const deleteRequest = store.delete(testData.slug);
                    deleteRequest.onsuccess = function() {
                        console.log('Test data cleaned up');
                    };
                };
                
                addRequest.onerror = function(e) {
                    addResult('error', 'âŒ å†™å…¥æƒé™å¼‚å¸¸', `æ— æ³•å†™å…¥æ•°æ®: ${e.target.error}`);
                };
                
            } catch (error) {
                addResult('error', 'âŒ æƒé™æµ‹è¯•å¤±è´¥', `é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•å¯¼èˆªåŠŸèƒ½
        function testNavigation() {
            clearResults();
            addResult('', 'ğŸ§­ å¯¼èˆªåŠŸèƒ½æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•è·¯ç”±å’Œå¯¼èˆªåŠŸèƒ½...');

            // æ£€æŸ¥å½“å‰ URL
            addResult('', 'ğŸ“ å½“å‰ä½ç½®ä¿¡æ¯', `
                <ul>
                    <li>URL: ${window.location.href}</li>
                    <li>åè®®: ${window.location.protocol}</li>
                    <li>ä¸»æœº: ${window.location.host}</li>
                    <li>è·¯å¾„: ${window.location.pathname}</li>
                    <li>æŸ¥è¯¢å‚æ•°: ${window.location.search}</li>
                </ul>
            `);

            // æµ‹è¯• History API
            if ('pushState' in window.history) {
                addResult('success', 'âœ… History API æ”¯æŒ', 'pushState å’Œ replaceState å¯ç”¨');
            } else {
                addResult('error', 'âŒ History API ä¸æ”¯æŒ', 'æ— æ³•ä½¿ç”¨ç°ä»£è·¯ç”±åŠŸèƒ½');
            }

            // æµ‹è¯•å¯¼èˆªåˆ°ä¸»é¡µ
            addResult('', 'ğŸ  å¯¼èˆªæµ‹è¯•', `
                <div style="margin: 10px 0;">
                    <button onclick="window.location.href='/'" style="background: #28a745;">
                        ğŸ  å¯¼èˆªåˆ°ä¸»é¡µ
                    </button>
                    <button onclick="window.location.href='/settings'" style="background: #6c757d;">
                        âš™ï¸ å¯¼èˆªåˆ°è®¾ç½®
                    </button>
                    <button onclick="testCreatePageNavigation()" style="background: #007bff;">
                        â• æµ‹è¯•åˆ›å»ºé¡µé¢å¯¼èˆª
                    </button>
                </div>
            `);
        }

        // æµ‹è¯•åˆ›å»ºé¡µé¢å¯¼èˆª
        function testCreatePageNavigation() {
            const timestamp = Date.now();
            const slug = `test-nav-${timestamp}`;
            const url = `/page/${slug}?new=true`;
            
            addResult('', 'ğŸ§ª åˆ›å»ºé¡µé¢å¯¼èˆªæµ‹è¯•', `
                <p>å‡†å¤‡å¯¼èˆªåˆ°: <code>${url}</code></p>
                <div style="margin: 10px 0;">
                    <button onclick="window.location.href='${url}'" style="background: #28a745;">
                        ğŸš€ ç«‹å³å¯¼èˆª
                    </button>
                    <button onclick="window.open('${url}', '_blank')" style="background: #17a2b8;">
                        ğŸ”— æ–°æ ‡ç­¾é¡µæ‰“å¼€
                    </button>
                </div>
            `);
        }

        // æ¨¡æ‹Ÿæ·»åŠ é¡µé¢
        async function simulateAddPage() {
            clearResults();
            addResult('', 'â• æ¨¡æ‹Ÿä¾§è¾¹æ æ·»åŠ é¡µé¢', 'æ­£åœ¨æ¨¡æ‹Ÿå®Œæ•´çš„æ·»åŠ é¡µé¢æµç¨‹...');

            try {
                // æ­¥éª¤ 1: ç”Ÿæˆå”¯ä¸€ slug
                const timestamp = Date.now();
                const slug = `untitled-${timestamp}`;
                addStep('success', `ğŸ“ ç”Ÿæˆ slug: ${slug}`);

                // æ­¥éª¤ 2: å‡†å¤‡é¡µé¢æ•°æ®
                const pageData = {
                    slug: slug,
                    title: 'Untitled',
                    content: {
                        type: 'doc',
                        content: [
                            {
                                type: 'paragraph',
                                content: [{ type: 'text', text: '' }]
                            }
                        ]
                    },
                    textContent: 'Untitled',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                addStep('success', 'ğŸ“‹ é¡µé¢æ•°æ®å‡†å¤‡å®Œæˆ');

                // æ­¥éª¤ 3: ä¿å­˜åˆ° IndexedDB
                const request = indexedDB.open('FuckNotionDB', 1);
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(['pages'], 'readwrite');
                    const store = transaction.objectStore('pages');
                    
                    const addRequest = store.add(pageData);
                    
                    addRequest.onsuccess = function() {
                        addStep('success', 'ğŸ’¾ é¡µé¢ä¿å­˜åˆ° IndexedDB æˆåŠŸ');
                        
                        // æ­¥éª¤ 4: å¯¼èˆªåˆ°æ–°é¡µé¢
                        const targetUrl = `/page/${slug}?new=true`;
                        addStep('success', `ğŸ§­ å‡†å¤‡å¯¼èˆªåˆ°: ${targetUrl}`);
                        
                        addResult('success', 'ğŸ‰ æ¨¡æ‹Ÿæ·»åŠ é¡µé¢æˆåŠŸï¼', `
                            <p>é¡µé¢åˆ›å»ºæµç¨‹å®Œæˆï¼Œç°åœ¨å¯ä»¥å¯¼èˆªåˆ°æ–°é¡µé¢ï¼š</p>
                            <div style="margin: 10px 0;">
                                <button onclick="window.location.href='${targetUrl}'" style="background: #28a745;">
                                    ğŸš€ æ‰“å¼€æ–°é¡µé¢
                                </button>
                                <button onclick="window.open('${targetUrl}', '_blank')" style="background: #17a2b8;">
                                    ğŸ”— æ–°æ ‡ç­¾é¡µæ‰“å¼€
                                </button>
                            </div>
                            <pre>${JSON.stringify(pageData, null, 2)}</pre>
                        `);
                    };
                    
                    addRequest.onerror = function(e) {
                        addStep('error', `âŒ ä¿å­˜å¤±è´¥: ${e.target.error}`);
                        
                        // å°è¯• localStorage å¤‡ç”¨æ–¹æ¡ˆ
                        addStep('', 'ğŸ”„ å°è¯• localStorage å¤‡ç”¨æ–¹æ¡ˆ...');
                        try {
                            const pages = JSON.parse(localStorage.getItem('novel-pages') || '{}');
                            pages[slug] = {
                                title: pageData.title,
                                content: pageData.content,
                                createdAt: pageData.createdAt.toISOString(),
                                updatedAt: pageData.updatedAt.toISOString()
                            };
                            localStorage.setItem('novel-pages', JSON.stringify(pages));
                            addStep('success', 'âœ… localStorage å¤‡ç”¨ä¿å­˜æˆåŠŸ');
                        } catch (localError) {
                            addStep('error', `âŒ localStorage å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥: ${localError.message}`);
                        }
                    };
                };
                
                request.onerror = function(e) {
                    addStep('error', `âŒ IndexedDB è¿æ¥å¤±è´¥: ${e.target.error}`);
                };

            } catch (error) {
                addStep('error', `âŒ æ¨¡æ‹Ÿè¿‡ç¨‹å¼‚å¸¸: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹æ£€æŸ¥
        window.addEventListener('load', function() {
            addResult('', 'ğŸš€ è°ƒè¯•å·¥å…·å·²åŠ è½½', `
                <p>å½“å‰æ—¶é—´: ${new Date().toLocaleString()}</p>
                <p>ç”¨æˆ·ä»£ç†: ${navigator.userAgent}</p>
                <p>IndexedDB æ”¯æŒ: ${'indexedDB' in window ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è°ƒè¯•ä¾§è¾¹æ æ·»åŠ é¡µé¢åŠŸèƒ½ã€‚</p>
            `);
        });
    </script>
</body>
</html>
